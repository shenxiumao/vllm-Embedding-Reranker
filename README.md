# Embedding & Reranker Proxy Service

ä¸€ä¸ªä¸“é—¨ä¸ºQwen3 Embeddingå’ŒRerankeræ¨¡å‹è®¾è®¡çš„é«˜æ€§èƒ½ä»£ç†æœåŠ¡ç³»ç»Ÿã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œç”¨äºéƒ¨ç½²å’Œç®¡ç†Qwen3-Embedding-0.6Bå’ŒQwen3-Reranker-0.6Bæ¨¡å‹æœåŠ¡ï¼ŒåŒ…æ‹¬ï¼š

- **ä»£ç†æœåŠ¡å™¨**ï¼šç»Ÿä¸€çš„APIæ¥å£å’Œè®¤è¯ç®¡ç†
- **æ¨¡å‹ç®¡ç†è„šæœ¬**ï¼šè‡ªåŠ¨åŒ–çš„æ¨¡å‹å¯åŠ¨ã€åœæ­¢å’ŒçŠ¶æ€ç›‘æ§
- **é«˜å¹¶å‘ä¼˜åŒ–**ï¼šæ”¯æŒå¤§è§„æ¨¡å¹¶å‘è¯·æ±‚å¤„ç†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Applications                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP Requests
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Embedding & Reranker Proxy                    â”‚
â”‚                    (Port 2048)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   API Gateway   â”‚  â”‚  Authentication â”‚                 â”‚
â”‚  â”‚   Rate Limiting â”‚  â”‚   Load Balancer â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                   â”‚
                      â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Qwen3-Embedding-0.6B     â”‚ â”‚    Qwen3-Reranker-0.6B     â”‚
â”‚        (GPU 1)              â”‚ â”‚        (GPU 0)              â”‚
â”‚       Port 8000             â”‚ â”‚       Port 8001             â”‚
â”‚     Embedding Task          â”‚ â”‚      Scoring Task           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
ER/
â”œâ”€â”€ embedding_reranker_proxy.py    # ä¸»ä»£ç†æœåŠ¡å™¨
â”œâ”€â”€ start_vllm_models.sh           # æ¨¡å‹å¯åŠ¨è„šæœ¬
â”œâ”€â”€ stop_vllm_models.sh            # æ¨¡å‹åœæ­¢è„šæœ¬
â”œâ”€â”€ check_models_status.sh         # çŠ¶æ€æ£€æŸ¥è„šæœ¬
â”œâ”€â”€ README.md                      # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ logs/                          # æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ embedding_model.log        # Embeddingæ¨¡å‹æ—¥å¿—
â”‚   â”œâ”€â”€ reranker_model.log         # Rerankeræ¨¡å‹æ—¥å¿—
â”‚   â”œâ”€â”€ embedding.pid              # Embeddingè¿›ç¨‹PID
â”‚   â””â”€â”€ reranker.pid               # Rerankerè¿›ç¨‹PID
â””â”€â”€ er_api_keys.json              # APIå¯†é’¥é…ç½®æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿ç³»ç»Ÿå·²å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š

```bash
# Pythonä¾èµ–
pip install fastapi uvicorn httpx pydantic

# vLLMå®‰è£…
pip install vllm

# ç³»ç»Ÿå·¥å…·
sudo apt-get install curl
```

### 2. æ¨¡å‹éƒ¨ç½²

ç¡®ä¿æ¨¡å‹æ–‡ä»¶ä½äºæ­£ç¡®è·¯å¾„ï¼š
- Embeddingæ¨¡å‹ï¼š`/mnt/workspace/model/Qwen/Qwen3-Embedding-0.6B`
- Rerankeræ¨¡å‹ï¼š`/mnt/workspace/model/Qwen/Qwen3-Reranker-0.6B`

### 3. å¯åŠ¨æœåŠ¡

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/data/vllm-serve/ER

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x *.sh

# å¯åŠ¨vLLMæ¨¡å‹æœåŠ¡
./start_vllm_models.sh

# ç­‰å¾…æ¨¡å‹åŠ è½½å®Œæˆåï¼Œå¯åŠ¨ä»£ç†æœåŠ¡å™¨
python embedding_reranker_proxy.py
```

### 4. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æ¨¡å‹çŠ¶æ€
./check_models_status.sh

# æµ‹è¯•APIæ¥å£
curl http://localhost:2048/health
```

## ğŸ”§ é…ç½®è¯´æ˜

### æ¨¡å‹é…ç½®

| æ¨¡å‹ | GPU | ç«¯å£ | ä»»åŠ¡ç±»å‹ | å†…å­˜åˆ©ç”¨ç‡ |
|------|-----|------|----------|------------|
| Qwen3-Embedding-0.6B | GPU 1 | 8000 | embed | 90% |
| Qwen3-Reranker-0.6B | GPU 0 | 8001 | score | 97% |

### ä»£ç†æœåŠ¡å™¨é…ç½®

- **ç«¯å£**ï¼š2048
- **å·¥ä½œè¿›ç¨‹**ï¼š64
- **å¹¶å‘é™åˆ¶**ï¼š500
- **é€Ÿç‡é™åˆ¶**ï¼š100æ¬¡/åˆ†é’Ÿ
- **è¶…æ—¶è®¾ç½®**ï¼š600ç§’

### APIå¯†é’¥ç®¡ç†

ç³»ç»Ÿä¼šè‡ªåŠ¨ç”ŸæˆAPIå¯†é’¥å¹¶ä¿å­˜åœ¨`er_api_keys.json`æ–‡ä»¶ä¸­ã€‚é¦–æ¬¡å¯åŠ¨æ—¶ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºç”Ÿæˆçš„å¯†é’¥ã€‚

## ğŸ“š APIä½¿ç”¨æŒ‡å—

### è®¤è¯æ–¹å¼

æ”¯æŒä¸¤ç§è®¤è¯æ–¹å¼ï¼š

1. **è¯·æ±‚å¤´è®¤è¯**ï¼š
   ```bash
   curl -H "Authorization: Bearer YOUR_API_KEY" http://localhost:2048/v1/models
   ```

2. **æŸ¥è¯¢å‚æ•°è®¤è¯**ï¼š
   ```bash
   curl "http://localhost:2048/v1/models?api_key=YOUR_API_KEY"
   ```

### ä¸»è¦ç«¯ç‚¹

#### 1. è·å–æ¨¡å‹åˆ—è¡¨
```bash
curl -H "Authorization: Bearer YOUR_API_KEY" \
     http://localhost:2048/v1/models
```

#### 2. æ–‡æœ¬åµŒå…¥
```bash
curl -X POST \
     -H "Authorization: Bearer YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{
       "model": "Qwen3-Embedding-0.6B",
       "input": "Hello, world!"
     }' \
     http://localhost:2048/v1/embeddings
```

#### 3. æ–‡æœ¬é‡æ’åº
```bash
curl -X POST \
     -H "Authorization: Bearer YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{
       "model": "Qwen3-Reranker-0.6B",
       "query": "What is AI?",
       "documents": ["AI is artificial intelligence", "AI helps humans"]
     }' \
     http://localhost:2048/v1/rerank
```

#### 4. å¥åº·æ£€æŸ¥
```bash
curl http://localhost:2048/health
```

## ğŸ› ï¸ è¿ç»´ç®¡ç†

### å¯åŠ¨æœåŠ¡
```bash
./start_vllm_models.sh    # å¯åŠ¨vLLMæ¨¡å‹
python embedding_reranker_proxy.py  # å¯åŠ¨ä»£ç†æœåŠ¡
```

### åœæ­¢æœåŠ¡
```bash
./stop_vllm_models.sh     # åœæ­¢vLLMæ¨¡å‹
# Ctrl+C åœæ­¢ä»£ç†æœåŠ¡
```

### çŠ¶æ€ç›‘æ§
```bash
./check_models_status.sh  # æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
```

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹Embeddingæ¨¡å‹æ—¥å¿—
tail -f logs/embedding_model.log

# æŸ¥çœ‹Rerankeræ¨¡å‹æ—¥å¿—
tail -f logs/reranker_model.log

# æŸ¥çœ‹ä»£ç†æœåŠ¡æ—¥å¿—
tail -f embedding_reranker_proxy.log
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘æ€§èƒ½
- **64ä¸ªå·¥ä½œè¿›ç¨‹**ï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸CPU
- **500å¹¶å‘è¿æ¥**ï¼šæ”¯æŒå¤§è§„æ¨¡å¹¶å‘è¯·æ±‚
- **è¿æ¥æ± ä¼˜åŒ–**ï¼šå‡å°‘è¿æ¥å¼€é”€ï¼Œæé«˜å“åº”é€Ÿåº¦

### GPUä¼˜åŒ–
- **GPUåˆ†ç¦»éƒ¨ç½²**ï¼šé¿å…æ˜¾å­˜ç«äº‰
- **é«˜å†…å­˜åˆ©ç”¨ç‡**ï¼šæœ€å¤§åŒ–GPUèµ„æºä½¿ç”¨
- **ä¼˜åŒ–çš„å—å¤§å°**ï¼šå¹³è¡¡å†…å­˜å’Œæ€§èƒ½

### ç½‘ç»œä¼˜åŒ–
- **Keep-Aliveè¿æ¥**ï¼šå‡å°‘è¿æ¥å»ºç«‹å¼€é”€
- **HTTP/2æ”¯æŒ**ï¼šæé«˜ä¼ è¾“æ•ˆç‡
- **æ™ºèƒ½è´Ÿè½½å‡è¡¡**ï¼šè‡ªåŠ¨è·¯ç”±åˆ°æœ€ä¼˜åç«¯

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **429 Too Many Requests**
   - æ£€æŸ¥é€Ÿç‡é™åˆ¶é…ç½®
   - å¢åŠ `rate_limit`å€¼
   - ä½¿ç”¨å¤šä¸ªAPIå¯†é’¥åˆ†æ•£è¯·æ±‚

2. **503 Service Unavailable**
   - æ£€æŸ¥åç«¯æ¨¡å‹æœåŠ¡çŠ¶æ€
   - éªŒè¯GPUèµ„æºå¯ç”¨æ€§
   - æŸ¥çœ‹æ¨¡å‹æ—¥å¿—æ’æŸ¥å¯åŠ¨é—®é¢˜

3. **504 Gateway Timeout**
   - å¢åŠ è¶…æ—¶æ—¶é—´é…ç½®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ä¼˜åŒ–æ¨¡å‹æ¨ç†æ€§èƒ½

### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥GPUçŠ¶æ€
nvidia-smi

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep -E '(8000|8001|2048)'

# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
ps aux | grep vllm
ps aux | grep embedding_reranker_proxy

# æµ‹è¯•æ¨¡å‹API
curl http://localhost:8000/health
curl http://localhost:8001/health
```

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### ç³»ç»ŸæŒ‡æ ‡
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- GPUåˆ©ç”¨ç‡å’Œæ˜¾å­˜ä½¿ç”¨
- ç½‘ç»œI/O

### åº”ç”¨æŒ‡æ ‡
- è¯·æ±‚å“åº”æ—¶é—´
- è¯·æ±‚æˆåŠŸç‡
- å¹¶å‘è¿æ¥æ•°
- APIè°ƒç”¨é¢‘ç‡

### ä¸šåŠ¡æŒ‡æ ‡
- åµŒå…¥å‘é‡ç”Ÿæˆé€Ÿåº¦
- é‡æ’åºå‡†ç¡®æ€§
- ç”¨æˆ·æ»¡æ„åº¦

## ğŸ”’ å®‰å…¨è€ƒè™‘

- **APIå¯†é’¥è®¤è¯**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢APIæ»¥ç”¨
- **æ—¥å¿—è®°å½•**ï¼šå®Œæ•´çš„è®¿é—®å®¡è®¡
- **HTTPSæ”¯æŒ**ï¼šæ•°æ®ä¼ è¾“åŠ å¯†ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š

1. æŸ¥çœ‹ç›¸å…³æ—¥å¿—æ–‡ä»¶
2. è¿è¡ŒçŠ¶æ€æ£€æŸ¥è„šæœ¬
3. æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
4. å‚è€ƒæ•…éšœæ’é™¤ç« èŠ‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªç›¸åº”çš„å¼€æºè®¸å¯è¯ã€‚ä½¿ç”¨å‰è¯·ç¡®ä¿éµå®ˆç›¸å…³æ¨¡å‹çš„ä½¿ç”¨æ¡æ¬¾ã€‚

---

**æ³¨æ„**ï¼šæœ¬æ–‡æ¡£åŸºäºå½“å‰é…ç½®ç¼–å†™ï¼Œå®é™…éƒ¨ç½²æ—¶è¯·æ ¹æ®å…·ä½“ç¯å¢ƒè°ƒæ•´ç›¸å…³å‚æ•°ã€‚